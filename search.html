<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>TTAT Result Online — ค้นหาข้อมูลนักกีฬา</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b2038; --panel:#0f2b4c; --muted:#9db0d1; --text:#e7f0ff; --accent:#2ea0ff;
      --row:#122c50; --row2:#123259; --border:#1d4672; --warn:#ffcc66;
    }
    *{box-sizing:border-box}  html,body{margin:0; font-family:Inter,system-ui,Arial}
    body{background:var(--bg); color:var(--text)}
    header{background:#062449; padding:18px 16px; font-size:20px; font-weight:700}
    .container{max-width:1100px; margin:28px auto; padding:0 16px}
    a.back{display:inline-block; color:var(--muted); text-decoration:none; margin-bottom:14px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px}
    .controls{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px}
    input[type="text"]{background:#0b2241; color:var(--text); border:1px solid var(--border);
      padding:12px 14px; border-radius:10px; min-width:260px}
    button{background:#0f5130; border:1px solid #0f5130; color:#fff; padding:12px 18px;
      border-radius:10px; cursor:pointer; font-weight:600}
    button.secondary{background:#0b2241; border:1px solid var(--border)}
    button:hover{filter:brightness(1.03)}
    .muted{color:var(--muted); font-size:13px}
    .name{margin:8px 2px 14px; color:#bfe1ff}

    table{width:100%; border-collapse:collapse; font-size:14px; overflow:hidden; border-radius:10px}
    thead th{background:#0a2a53; text-align:left; padding:11px 12px; border-bottom:1px solid var(--border)}
    tbody td{padding:11px 12px; border-bottom:1px solid var(--border)}
    tbody tr{background:var(--row)}
    tbody tr:nth-child(even){background:var(--row2)}
    .warn{color:var(--warn); font-size:13px; margin-top:10px}
    .right{float:right; font-size:13px}
    .pill{display:inline-block; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted)}
  </style>
</head>
<body>
  <header>TTAT Result Online — ค้นหาข้อมูลนักกีฬา</header>

  <div class="container">
    <a class="back" href="./index.html">← กลับหน้าหลัก</a>

    <div class="card">
      <div class="controls">
        <input id="qName" type="text" placeholder="พิมพ์ชื่อ-สกุล นักกีฬา เช่น ภาคภูมิ สงวนสิน" />
        <button id="btnSearch">ค้นหา</button>
        <button id="btnClear" class="secondary">ล้าง</button>
        <input id="qFilter" type="text" placeholder="กรองคำใน ‘รายการ’ หรือ ‘ประเภท’ (ไม่บังคับ)" style="flex:1 1 260px" />
      </div>

      <div class="name" id="selName" hidden>
        นักกีฬา: <span class="pill" id="selNameTxt"></span>
        <span class="right muted" id="countTxt"></span>
      </div>

      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th style="width:120px">ปี จัดแข่งขัน</th>
              <th>รายการ</th>
              <th style="width:280px">ประเภท</th>
              <th style="width:160px">ตำแหน่ง</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="4" class="muted">กำลังโหลดข้อมูล…</td></tr>
          </tbody>
        </table>
        <div id="warn" class="warn" hidden></div>
      </div>
    </div>
  </div>

  <!-- PapaParse สำหรับอ่าน CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // ใช้ไฟล์ CSV ในโฟลเดอร์เดียวกับ search.html
    const CSV_URL = 'data.csv';

    const el = (id)=>document.getElementById(id);
    const $rows = el('rows');
    const $nameBox = el('selName');
    const $nameTxt = el('selNameTxt');
    const $countTxt = el('countTxt');
    const $warn = el('warn');

    let DATA = [];  // เก็บข้อมูลทั้งหมดหลังโหลด
    let LOADED = false;

    // ปรับข้อความให้เปรียบเทียบได้: ตัดเว้นวรรคเกิน, ตัด non-breaking space, lower case
    const normalize = s => String(s||'')
      .replace(/\u00A0/g,' ')
      .replace(/\s+/g,' ')
      .trim()
      .toLowerCase();

    // โหลด CSV
    async function loadCSV(){
      try{
        const res = await fetch(CSV_URL, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const text = await res.text();
        const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
        DATA = parsed.data.map(r => ({
          name: (r['ชื่อ - สกุล'] ?? '').trim(),
          year: (r['ปี จัดแข่งขัน'] ?? '').toString().trim(),
          event: (r['รายการ'] ?? '').trim(),
          type: (r['ประเภท'] ?? '').trim(),
          pos:  (r['ตำแหน่ง'] ?? '').trim()
        }));
        LOADED = true;
        $rows.innerHTML = '<tr><td colspan="4" class="muted">กรุณาพิมพ์ชื่อ-สกุล แล้วกดค้นหา</td></tr>';
      }catch(err){
        console.error(err);
        $rows.innerHTML = '<tr><td colspan="4">โหลดข้อมูลไม่สำเร็จ</td></tr>';
        $warn.hidden = false;
        $warn.textContent = 'หากใช้ GitHub Pages ให้แน่ใจว่าไฟล์ data.csv อยู่โฟลเดอร์เดียวกับหน้า และไม่มีการ cache เก่า';
      }
    }

    function renderRows(list){
      if(!list.length){
        $rows.innerHTML = '<tr><td colspan="4" class="muted">ไม่พบข้อมูล</td></tr>';
        $countTxt.textContent = '';
        return;
      }
      // sort ปี (ตัวเลข) จากมาก→น้อย
      list.sort((a,b)=>Number(b.year)-Number(a.year));

      const html = list.map(r=>`
        <tr>
          <td>${r.year||'-'}</td>
          <td>${r.event||'-'}</td>
          <td>${r.type||'-'}</td>
          <td>${r.pos||'-'}</td>
        </tr>
      `).join('');
      $rows.innerHTML = html;
      $countTxt.textContent = `ทั้งหมด ${list.length.toLocaleString('th-TH')} รายการ`;
    }

    function doSearch(){
      if(!LOADED) return;

      const qName = normalize(el('qName').value);
      const qFilter = normalize(el('qFilter').value);

      if(!qName){
        $nameBox.hidden = true;
        $rows.innerHTML = '<tr><td colspan="4" class="muted">กรุณาพิมพ์ชื่อ-สกุล แล้วกดค้นหา</td></tr>';
        $countTxt.textContent = '';
        return;
      }

      // เทียบชื่อแบบเข้มงวด: ชื่อที่ normalize แล้วต้องตรงกัน (ไม่สนใจเคส/เว้นวรรคย้วย)
      const out = DATA.filter(r => normalize(r.name) === qName)
                     .filter(r => !qFilter
                                  || normalize(r.event).includes(qFilter)
                                  || normalize(r.type).includes(qFilter));

      // แสดงชื่อบนหัว
      $nameTxt.textContent = DATA.find(r => normalize(r.name) === qName)?.name || el('qName').value.trim();
      $nameBox.hidden = false;

      renderRows(out);
    }

    function clearAll(){
      el('qName').value = '';
      el('qFilter').value = '';
      $nameBox.hidden = true;
      $rows.innerHTML = '<tr><td colspan="4" class="muted">กรุณาพิมพ์ชื่อ-สกุล แล้วกดค้นหา</td></tr>';
      $countTxt.textContent = '';
      el('qName').focus();
    }

    // events
    document.addEventListener('DOMContentLoaded', loadCSV);
    el('btnSearch').addEventListener('click', doSearch);
    el('btnClear').addEventListener('click', clearAll);
    el('qName').addEventListener('keydown', e => { if(e.key==='Enter') doSearch(); });
    el('qFilter').addEventListener('input', () => {
      // กรองใหม่แบบทันทีถ้ามีผลลัพธ์อยู่แล้ว
      if(!$nameBox.hidden) doSearch();
    });
  </script>
</body>
</html>
