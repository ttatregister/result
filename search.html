<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=1280" />
<title>TTAT Result Online — ค้นหาข้อมูลนักกีฬา</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b2236; --panel:#0f2d49; --line:#103a5a; --text:#e7f3ff;
    --muted:#9db0c7; --accent:#37b3ff; --accent-2:#0a915c;
  }
  html,body{margin:0;padding:0;min-width:1280px;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial}
  a{color:#8fd0ff;text-decoration:none}
  a:hover{text-decoration:underline}
  header{background:#062346;padding:16px 24px;font-weight:700;font-size:20px}
  .wrap{max-width:1180px;margin:28px auto;padding:0 16px}
  .back{margin-bottom:10px;display:inline-block}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:18px 18px 8px}
  .controls{display:flex;gap:12px;margin-bottom:12px}
  input[type="text"]{flex:1;min-width:320px;background:#0b2236;color:var(--text);border:1px solid var(--line);
    border-radius:10px;padding:12px 14px;font-size:15px;outline:none}
  input::placeholder{color:var(--muted)}
  .btn{background:#1473e6;border:1px solid #0e5bb8;color:#fff;border-radius:10px;padding:10px 18px;font-size:15px;cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .btn-ghost{background:#143e5f;border:1px solid var(--line)}
  .count{color:var(--muted);font-size:13px;margin:6px 0 14px}
  .who{color:#cce9ff;font-size:14px;margin:-6px 0 10px}
  table{width:100%;border-collapse:collapse;font-size:14px;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  thead th{background:#0e2f4f;color:#fff;font-weight:700;text-align:left;padding:12px;border-bottom:1px solid var(--line);position:relative;user-select:none;cursor:pointer}
  tbody td{padding:11px 12px;border-bottom:1px solid var(--line)}
  tbody tr:nth-child(odd){background:#0e2a46}
  tbody tr:nth-child(even){background:#0f2d49}
  .muted{color:var(--muted)}
  .hide-name th.col-name,.hide-name td.col-name{display:none}
  .sort{position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:12px;color:#8fd0ff}
  .badge{display:inline-block;background:#0a915c;border:1px solid #08764a;color:#eafff6;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px}
</style>

<!-- ใช้ Papaparse แยก CSV ให้ทนทาน -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<header>TTAT Result Online — ค้นหาข้อมูลนักกีฬา</header>

<div class="wrap">
  <a class="back" href="./">← กลับหน้าหลัก</a>

  <div class="card">
    <div class="controls">
      <input id="q-name" type="text" placeholder="พิมพ์ชื่อ-สกุล (พิมพบางส่วนได้ เช่น ภาคภูมิ)" />
      <button id="btn-search" class="btn">ค้นหา</button>
      <button id="btn-clear" class="btn btn-ghost">ล้าง</button>
      <input id="q-free" type="text" placeholder="กรองคำใน ‘รายการ’ หรือ ‘ประเภท’ (ไม่บังคับ)"/>
    </div>

    <div id="count" class="count"></div>
    <div id="who" class="who"></div>

    <div id="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th class="col-name" data-key="name">ชื่อ - สกุล <span class="sort" id="s-name"></span></th>
            <th data-key="year">ปี จัดแข่งขัน <span class="sort" id="s-year"></span></th>
            <th data-key="event">รายการ <span class="sort" id="s-event"></span></th>
            <th data-key="type">ประเภท <span class="sort" id="s-type"></span></th>
            <th data-key="pos">ตำแหน่ง <span class="sort" id="s-pos"></span></th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="5" class="muted">กำลังโหลดข้อมูล…</td></tr>
        </tbody>
      </table>
    </div>

  </div>
</div>

<script>
/* ===================== ตั้งค่าแหล่งข้อมูล CSV ===================== */
const DATA_URL = 'data.csv'; // อยู่โฟลเดอร์เดียวกับไฟล์นี้

/* ===================== Utility ===================== */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const $name = $('#q-name');
const $free = $('#q-free');
const $btnSearch = $('#btn-search');
const $btnClear  = $('#btn-clear');
const $rows = $('#rows');
const $count = $('#count');
const $who = $('#who');
const $tableWrap = $('#table-wrap');
const $head = $('#tbl thead');

let ALL = [];     // data ทั้งหมด
let VIEW = [];    // data หลังกรอง
let SORT = {key:'year', dir:'desc'};  // เริ่มต้นเรียงปีมาก→น้อย

// normalize ข้อความ (trim + ช่องว่างเดียว)
const norm = s => (s || '').toString().trim().replace(/\s+/g,' ');
// เหมือนเดิม แต่ lower-case เผื่อกรณีมีอักษรโรมัน/ตัวเลข
const normLower = s => norm(s).toLowerCase();

// Levenshtein distance
function lev(a,b){
  a = norm(a); b = norm(b);
  const m = a.length, n = b.length;
  const dp = Array.from({length:m+1},()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0] = i;
  for(let j=0;j<=n;j++) dp[0][j] = j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1] === b[j-1] ? 0 : 1;
      dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
    }
  }
  return dp[m][n];
}
// fuzzy match ชื่อ: ยอมพิมพ์ผิด 1–2 ตัวอักษร (ตามความยาว query)
function fuzzyMatchName(fullName, q){
  if(!q) return true;
  const needle = normLower(q);
  const hay = normLower(fullName);
  // partial contains ก่อน
  if(hay.includes(needle)) return true;
  // ถามคลาดเคลื่อน: threshold ตามความยาวคำค้น
  const th = Math.max(1, Math.min(2, Math.floor(needle.length/5)));
  return lev(hay, needle) <= th;
}
// กรองคำในรายการ/ประเภท: รองรับหลายคำคั่นด้วยช่องว่าง
function freeFilter(ok1, ok2, q){
  if(!q) return true;
  const tokens = normLower(q).split(' ').filter(Boolean);
  const text = `${normLower(ok1)} ${normLower(ok2)}`;
  return tokens.every(t => text.includes(t));
}

/* ===================== โหลด CSV ===================== */
async function loadData(){
  try{
    const res = await fetch(DATA_URL, {cache:'no-store'});
    if(!res.ok) throw new Error('โหลดไฟล์ CSV ไม่ได้');
    const csv = await res.text();
    const parsed = Papa.parse(csv, {header:true, skipEmptyLines:true});
    const rows = parsed.data;
    // ชื่อคอลัมน์คาดหวัง: ชื่อ - สกุล, ปี จัดแข่งขัน, รายการ, ประเภท, ตำแหน่ง
    ALL = rows.map(r => ({
      name: norm(r['ชื่อ - สกุล']),
      year: norm(r['ปี จัดแข่งขัน']),
      event: norm(r['รายการ']),
      type: norm(r['ประเภท']),
      pos:  norm(r['ตำแหน่ง'])
    })).filter(r => r.name || r.event || r.type || r.pos);
    doSearch(); // แสดงครั้งแรก
  }catch(e){
    console.error(e);
    $rows.innerHTML = `<tr><td colspan="5" class="muted">โหลดข้อมูลล้มเหลว: ${e.message}</td></tr>`;
  }
}

/* ===================== ค้นหา/เรนเดอร์ ===================== */
function applySort(list){
  const {key, dir} = SORT;
  const sign = dir === 'asc' ? 1 : -1;
  return list.slice().sort((a,b)=>{
    if(key === 'year'){
      const A = parseInt(a.year||'0',10), B = parseInt(b.year||'0',10);
      return (A === B ? 0 : (A > B ? 1 : -1)) * sign;
    }else{
      const A = (a[key]||'').toString();
      const B = (b[key]||'').toString();
      return A.localeCompare(B,'th',{numeric:true,sensitivity:'base'}) * sign;
    }
  });
}

function renderSortIcon(){
  // เคลียร์ทั้งหมด
  $$('.sort').forEach(el => el.textContent = '');
  const map = {name:'#s-name', year:'#s-year', event:'#s-event', type:'#s-type', pos:'#s-pos'};
  const $icon = $(map[SORT.key]);
  if($icon) $icon.textContent = SORT.dir === 'asc' ? '▲' : '▼';
}

function renderRows(list, hideName){
  renderSortIcon();
  // ซ่อนคอลัมน์ชื่อหรือไม่
  $tableWrap.classList.toggle('hide-name', !!hideName);

  if(!list.length){
    $rows.innerHTML = `<tr><td colspan="5" class="muted">ไม่พบข้อมูล</td></tr>`;
    $count.textContent = '';
    return;
  }
  list = applySort(list);

  const html = list.map(r => `
    <tr>
      <td class="col-name">${r.name || '-'}</td>
      <td>${r.year || '-'}</td>
      <td>${r.event || '-'}</td>
      <td>${r.type || '-'}</td>
      <td>${r.pos  || '-'}</td>
    </tr>
  `).join('');
  $rows.innerHTML = html;
  $count.textContent = `ทั้งหมด ${list.length.toLocaleString('th-TH')} รายการ`;
}

function doSearch(){
  const qn = norm($name.value);
  const qf = norm($free.value);

  VIEW = ALL.filter(r=>{
    const okName = qn ? fuzzyMatchName(r.name, qn) : true;
    const okFree = qf ? freeFilter(r.event, r.type, qf) : true;
    return okName && okFree;
  });

  // แสดงชื่อที่ค้นไว้ด้านบน และซ่อนคอลัมน์ชื่อเมื่อมีชื่อ
  $who.textContent = qn ? `ผลสำหรับ: “${qn}”` : '';
  renderRows(VIEW, !!qn);
}

/* ===================== การทำงานของ UI ===================== */
$name.addEventListener('keydown', e => { if(e.key === 'Enter') doSearch(); });
$free.addEventListener('keydown', e => { if(e.key === 'Enter') doSearch(); });
$btnSearch.addEventListener('click', doSearch);
$btnClear.addEventListener('click', ()=>{
  $name.value = ''; $free.value = '';
  $who.textContent = '';
  doSearch();
});

// คลิกหัวคอลัมน์เพื่อเรียง
$head.addEventListener('click', e=>{
  const th = e.target.closest('th');
  if(!th) return;
  const key = th.dataset.key;
  if(!key) return;
  if(SORT.key === key){
    SORT.dir = (SORT.dir === 'asc' ? 'desc' : 'asc');
  }else{
    SORT.key = key;
    SORT.dir = (key === 'year') ? 'desc' : 'asc';
  }
  renderRows(VIEW, !!norm($name.value));
});

// เริ่มทำงาน
loadData();
</script>
</body>
</html>
