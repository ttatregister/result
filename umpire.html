<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>รายชื่อผู้ตัดสินสมาคม • TTAT Umpire Directory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ฟอนต์ -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- PapaParse สำหรับอ่าน CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#0c2a46;
      --panel:#0f3656;
      --panel-2:#0d2f4b;
      --line:#1e4464;
      --text:#eaf3ff;
      --muted:#9fb7d3;
      --accent:#21a2ff;
      --accent-2:#0f8ae0;
      --danger:#ffcc66;
      --success:#7bd389;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:'Kanit',system-ui,Arial}
    .container{max-width:1200px;margin-inline:auto;padding:20px}
    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .title{font-size:28px;font-weight:600;letter-spacing:.3px}
    .muted{color:var(--muted);font-size:14px}
    .filters{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:14px;margin:12px 0;display:grid;gap:10px;grid-template-columns:1fr 180px 180px 180px 180px}
    .filters input,.filters select{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:var(--panel-2);color:var(--text);font-size:14px;outline:none
    }
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--panel);border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:13px;margin-right:6px}
    .btn{
      background:var(--accent);border:none;color:white;border-radius:8px;padding:10px 14px;font-size:14px;cursor:pointer
    }
    .btn:hover{background:var(--accent-2)}
    table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    thead th{
      background:#0c3d63;
      color:var(--text);
      font-weight:600;
      padding:12px;
      font-size:14px;
      border-bottom:1px solid var(--line);
      user-select:none;
      position:relative;
      cursor:pointer;
    }
    thead th .sort{
      font-size:11px;color:var(--muted);
      position:absolute;right:10px;top:50%;transform:translateY(-50%);
    }
    tbody td{padding:12px;border-bottom:1px solid var(--line);font-size:14px}
    tbody tr:hover{background:rgba(255,255,255,.04)}
    .tag{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);color:var(--text);background:var(--panel-2)}
    .tag.green{border-color:#2b7f57;background:#1d583d;color:#d5ffe7}
    .tag.yellow{border-color:#8a6d1f;background:#5a4714;color:#fff0bf}
    .count{margin:8px 2px 14px;font-size:14px;color:var(--muted)}
    .footer{margin:28px 0 16px;color:var(--muted);font-size:13px;text-align:right}
    @media (max-width:1100px){
      .filters{grid-template-columns:1fr 1fr 1fr 1fr;gap:8px}
    }
    @media (max-width:820px){
      .filters{grid-template-columns:1fr 1fr;gap:8px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="title">รายชื่อผู้ตัดสินสมาคม • TTAT Umpire Directory</div>
      <div class="pill">ค้นหา/กรองได้</div>
      <div class="pill">TH/EN</div>
      <div class="muted" id="last-updated"></div>
    </div>

    <!-- แถวตัวกรอง -->
    <div class="filters">
      <input id="q" type="text" placeholder="ค้นหาชื่อ (พิมพ์บางส่วนได้)..." />
      <select id="role">
        <option value="">บทบาท: ทั้งหมด</option>
        <option value="Umpire">Umpire</option>
      </select>
      <select id="status">
        <option value="">สถานะ: ทั้งหมด</option>
        <option>Active</option>
        <option>Inactive</option>
        <option>Suspended</option>
      </select>
      <select id="level">
        <option value="">ระดับ: ทั้งหมด</option>
      </select>
      <select id="country">
        <option value="">ประเทศ: ทั้งหมด</option>
      </select>
    </div>

    <div class="count" id="count">กำลังโหลดข้อมูล…</div>

    <table id="tbl">
      <thead>
        <tr>
          <th data-key="name">ชื่อ <span class="sort"></span></th>
          <th data-key="country">ประเทศ <span class="sort"></span></th>
          <th data-key="level">ระดับ <span class="sort"></span></th>
          <th data-key="role">บทบาท <span class="sort"></span></th>
          <th data-key="status">สถานะ <span class="sort"></span></th>
          <th data-key="remark">หมายเหตุ <span class="sort"></span></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="footer">© TTAT • Auto-generated directory</div>
  </div>

  <script>
    // ========= ตั้งค่าแหล่งข้อมูล =========
    const CSV_URL = 'https://ttatregister.github.io/result/Umpire_Status_Updates.csv';

    // แมปชื่อคอลัมน์จาก CSV -> ชื่อที่เว็บใช้
    const MAPPING = {
      name:   'Full Name',
      country:'Nationality',
      level:  'Umpire Level',
      status: 'Status',
      // ไม่มีใน CSV จึงเติมอัตโนมัติ
      role:   null,
      remark: null
    };

    const state = {
      raw: [],
      view: [],
      sortKey: 'name',
      sortDir: 'asc'
    };

    const $ = (s, p=document) => p.querySelector(s);
    const $$ = (s, p=document) => [...p.querySelectorAll(s)];
    const dom = {
      q: $('#q'),
      role: $('#role'),
      status: $('#status'),
      level: $('#level'),
      country: $('#country'),
      tblBody: $('#tbl tbody'),
      count: $('#count'),
      updated: $('#last-updated')
    };

    // ========= โหลดข้อมูลจาก CSV =========
    async function loadCSV(){
      return new Promise((resolve, reject)=>{
        Papa.parse(CSV_URL, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: (res)=> resolve(res.data),
          error: reject
        });
      });
    }

    // ทำความสะอาดข้อมูล และแมปฟิลด์
    function normalize(rows){
      return rows.map(r=>{
        const row = {
          name: (r[MAPPING.name] ?? '').trim(),
          country: (r[MAPPING.country] ?? '').trim(),
          level: (r[MAPPING.level] ?? '').trim(),
          status: (r[MAPPING.status] ?? '').trim(),
          role: 'Umpire',
          remark: ''
        };
        return row;
      }).filter(r => r.name); // เอาเฉพาะแถวที่มีชื่อจริง
    }

    // เติมรายการตัวเลือก (ระดับ/ประเทศ) จากข้อมูลจริง
    function populateFilters(data){
      const levels = [...new Set(data.map(d=>d.level).filter(Boolean))].sort();
      const countries = [...new Set(data.map(d=>d.country).filter(Boolean))].sort();

      // ล้างเดิม (คง option แรกไว้)
      dom.level.innerHTML = `<option value="">ระดับ: ทั้งหมด</option>` +
        levels.map(v=>`<option>${escapeHtml(v)}</option>`).join('');

      dom.country.innerHTML = `<option value="">ประเทศ: ทั้งหมด</option>` +
        countries.map(v=>`<option>${escapeHtml(v)}</option>`).join('');
    }

    // ฟังก์ชันกรอง
    function applyFilter(){
      const kw = dom.q.value.trim().toLowerCase();
      const role = dom.role.value;
      const st = dom.status.value;
      const lv = dom.level.value;
      const ct = dom.country.value;

      let out = state.raw.filter(r=>{
        // ชื่อ (พิมพ์บางส่วนได้)
        if(kw){
          const name = (r.name||'').toLowerCase();
          if(!name.includes(kw)) return false;
        }
        if(role && r.role !== role) return false;
        if(st && r.status !== st) return false;
        if(lv && r.level !== lv) return false;
        if(ct && r.country !== ct) return false;
        return true;
      });

      // เรียงลำดับตาม state
      out = sortBy(out, state.sortKey, state.sortDir);

      state.view = out;
      render();
    }

    // เรียงลำดับ
    function sortBy(arr, key, dir='asc'){
      const s = [...arr].sort((a,b)=>{
        const A = (a[key]??'').toString().toLowerCase();
        const B = (b[key]??'').toString().toLowerCase();
        if(A < B) return -1;
        if(A > B) return  1;
        return 0;
      });
      return dir==='desc' ? s.reverse() : s;
    }

    // วาดตาราง
    function render(){
      dom.tblBody.innerHTML = state.view.map(row=>{
        const statusTag = tagStatus(row.status);
        return `
          <tr>
            <td>${escapeHtml(row.name)}</td>
            <td>${escapeHtml(row.country)}</td>
            <td>${escapeHtml(row.level)}</td>
            <td><span class="tag">${escapeHtml(row.role)}</span></td>
            <td>${statusTag}</td>
            <td>${escapeHtml(row.remark||'')}</td>
          </tr>`;
      }).join('');

      dom.count.textContent = `ทั้งหมด ${state.view.length.toLocaleString('th-TH')} รายการ`;
      updateSortIcons();
    }

    function tagStatus(st=''){
      const s = st.trim();
      if(!s) return '';
      const cls = s.toLowerCase()==='active' ? 'green' :
                  s.toLowerCase()==='inactive' ? 'yellow' : '';
      return `<span class="tag ${cls}">${escapeHtml(s)}</span>`;
    }

    // ปลอดภัยต่อ HTML
    function escapeHtml(str=''){
      return str.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    // ไอคอนลูกศร sort บนหัวตาราง
    function updateSortIcons(){
      $$('#tbl thead th .sort').forEach(el=>el.textContent='');
      const th = $(`#tbl thead th[data-key="${state.sortKey}"] .sort`);
      if(th) th.textContent = state.sortDir==='asc' ? '▲' : '▼';
    }

    // จัดการเหตุการณ์
    function bindEvents(){
      ['input','change'].forEach(evt=>{
        dom.q.addEventListener(evt, debounce(applyFilter, 120));
      });
      dom.role.addEventListener('change', applyFilter);
      dom.status.addEventListener('change', applyFilter);
      dom.level.addEventListener('change', applyFilter);
      dom.country.addEventListener('change', applyFilter);

      // คลิกหัวคอลัมน์เพื่อเรียง
      $$('#tbl thead th').forEach(th=>{
        th.addEventListener('click', ()=>{
          const key = th.getAttribute('data-key');
          if(!key) return;
          if(state.sortKey === key){
            state.sortDir = state.sortDir==='asc' ? 'desc' : 'asc';
          }else{
            state.sortKey = key;
            state.sortDir = 'asc';
          }
          applyFilter();
        });
      });
    }

    // debounce ง่ายๆ
    function debounce(fn, ms=120){
      let t; 
      return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
    }

    // main
    (async function init(){
      try{
        const csvRows = await loadCSV();
        const data = normalize(csvRows);
        state.raw = data;
        populateFilters(data);
        dom.updated.textContent = `• อัปเดตล่าสุด ${new Date().toLocaleString('th-TH')}`;
        bindEvents();
        applyFilter();  // render ครั้งแรก
      }catch(err){
        console.error(err);
        dom.count.innerHTML = `โหลดข้อมูลไม่ได้ <span class="tag yellow">ลองรีเฟรช</span>`;
      }
    })();
  </script>
</body>
</html>
